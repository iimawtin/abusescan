#!/bin/bash

# 📌 مسیر ذخیره لیست بلاک‌شده
BLOCKLIST_CONF="/etc/abuse-blocklist.conf"

# 🛑 ساخت مجموعه ipset (در صورت نبود)
ipset list blacklist >/dev/null 2>&1 || ipset create blacklist hash:net
ipset list blacklist_subnet >/dev/null 2>&1 || ipset create blacklist_subnet hash:net

# 🚮 پاک‌سازی لیست فعلی برای جلوگیری از تکرار
ipset flush blacklist

# 🧩 لیست IPها و رنج‌های بلاک‌شده
BLOCKED_RANGES=(
    "218.92.0.0/16"
    "80.94.0.0/18"
    "5.188.0.0/17"
    "45.148.0.0/17"
    "83.222.0.0/18"
    "195.178.0.0/18"
    "207.90.0.0/18"
    "167.94.0.0/18"
    "57.129.0.0/17"
    "154.81.0.0/16"
    "102.192.0.0/16"
    "151.139.0.0/16"

    "10.0.0.0/8"
    "100.64.0.0/10"
    "169.254.0.0/16"
    "172.16.0.0/12"
    "192.0.0.0/24"
    "192.0.2.0/24"
    "192.88.99.0/24"
    "192.168.0.0/16"
    "198.18.0.0/15"
    "198.51.100.0/24"
    "203.0.113.0/24"
    "240.0.0.0/4"
    "224.0.0.0/4"
    "233.252.0.0/24"
    
    "102.0.0.0/8"
    "102.239.0.0/24"
    "103.29.38.0/24"
    "103.49.99.0/24"
    "103.58.50.0/24"
    "114.208.187.0/24"
    "1.174.0.0/24"
    "1.34.0.0/24"
    "14.136.0.0/24"
    "25.0.0.0/19"
    "25.29.155.0/24"
    "45.14.174.0/24"
    "185.235.86.0/24"
    "185.235.87.0/24"
    "195.137.167.0/24"
    "206.191.152.0/24"
    "213.195.0.0/24"
    "216.218.185.0/24"
    "220.133.0.0/24"
    "3.161.0.0/16"
    "3.206.0.0/16"
    "3.207.0.0/16"
    "5.174.0.0/16"
    "8.128.0.0/16"
    "9.162.0.0/16"
    "18.34.0.0/16"
    "24.161.0.0/16"
    "27.111.0.0/16"
    "27.121.0.0/16"
    "45.14.0.0/16"
    "45.235.0.0/16"
    "46.151.0.0/16"
    "48.72.0.0/16"
    "62.69.0.0/16"
    "64.27.0.0/16"
    "65.75.0.0/16"
    "69.22.0.0/16"
    "85.114.0.0/16"
    "87.120.0.0/16"
    "88.109.0.0/16"
    "91.98.0.0/16"
    "91.193.0.0/16"
    "91.195.0.0/16"
    "94.243.0.0/16"
    "95.81.0.0/16"
    "102.219.0.0/16"
    "102.220.0.0/16"
    "103.26.0.0/16"
    "103.54.0.0/16"
    "103.72.0.0/16"
    "103.112.0.0/16"
    "103.126.0.0/16"
    "103.134.0.0/16"
    "103.145.0.0/16"
    "103.152.0.0/16"
    "103.153.0.0/16"
    "103.166.0.0/16"
    "103.167.0.0/16"
    "103.169.0.0/16"
    "103.174.0.0/16"
    "104.37.0.0/16"
    "104.144.0.0/16"
    "114.134.0.0/16"
    "115.167.0.0/16"
    "117.127.0.0/16"
    "118.98.0.0/16"
    "119.2.0.0/16"
    "120.138.0.0/16"
    "154.83.0.0/16"
    "155.50.0.0/16"
    "156.226.0.0/16"
    "160.20.0.0/16"
    "160.22.0.0/16"
    "160.116.0.0/16"
    "168.194.0.0/16"
    "173.82.0.0/16"
    "173.98.0.0/16"
    "177.84.0.0/16"
    "180.234.0.0/16"
    "185.33.0.0/16"
    "189.222.0.0/16"
    "195.137.0.0/16"
    "201.53.0.0/16"
    "202.52.0.0/16"
    "202.91.0.0/16"
    "202.133.0.0/16"
    "202.134.0.0/16"
    "211.95.0.0/16"
    "212.64.0.0/16"
    "216.173.0.0/16"
    "220.224.0.0/16"
)

# ➕ افزودن به ipset
echo -e "\e[1;33m➕ افزودن رنج‌های جدید به ipset...\e[0m"
for IP in "${BLOCKED_RANGES[@]}"; do
    ipset add blacklist "$IP" 2>/dev/null
done

# 💾 ذخیره در فایل کانفیگ
echo -e "\e[1;34m💾 ذخیره تنظیمات در $BLOCKLIST_CONF\e[0m"
ipset save > "$BLOCKLIST_CONF"

# 🔄 اطمینان از اجرای ipset restore در هنگام بوت
grep -q "ipset restore < $BLOCKLIST_CONF" /etc/crontab || \
echo "@reboot root ipset restore < $BLOCKLIST_CONF" >> /etc/crontab

echo -e "\e[1;32m✅ لیست IPهای بلاک‌شده با موفقیت به‌روزرسانی شد.\e[0m"
